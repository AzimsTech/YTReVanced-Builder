name: Trigger YT Morphe Build daily

on: 
  schedule:
   - cron: '0 12 * * *'  # Daily build at 8:00 PM MYT (12:00 UTC)
  workflow_dispatch:

permissions:
  actions: write

jobs:
  trigger-foo:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout morphe branch
        uses: actions/checkout@v4
        with:
          ref: morphe  # Checkout the morphe branch
          fetch-depth: 0  # Fetch all tags

      - name: Compare current and latest versions
        id: get-last-patch
        run: |
          chmod +x *.sh
          latest_version=$(./get-dev-mpp.sh --version-only || true)
          
          # Fix 1: Filter tags to only include -morphe
          current_tag=$(git tag -l "*-morphe" --sort=-version:refname | head -n1 || true)

          # Fix 2: Use if blocks instead of && to prevent set -e workflow crashes
          if [ -z "$latest_version" ]; then latest_version="none"; fi
          if [ -z "$current_tag" ]; then current_tag="none"; fi
          
          should_skip="false"
          if [ "$current_tag" = "$latest_version" ]; then
            should_skip="true"
          fi
          
          echo "Latest version: $latest_version"
          echo "Current tag: $current_tag"
          echo "Should skip: $should_skip"
          
          {
            echo "latest_version=$latest_version"
            echo "current_tag=$current_tag"
            echo "should_skip=$should_skip"
          } >> "$GITHUB_OUTPUT"
      
      - name: Trigger YTMorphe build workflow on morphe branch
        if: steps.get-last-patch.outputs.should_skip != 'true'
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-morphe.yml',
              ref: 'morphe'
            })
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log skip reason
        if: steps.get-last-patch.outputs.should_skip == 'true'
        run: |
          echo "⏭️ Skipping build - no new version available"
          echo "Latest: ${{ steps.get-last-patch.outputs.latest_version }}"
          echo "Current: ${{ steps.get-last-patch.outputs.current_tag }}"